if(document.location.href.indexOf('/candidato') >= 0){
  app.votolegal.config(['$routeProvider', function($routeProvider) {
    $routeProvider.
    when('/', {
      templateUrl: '/javascripts/app/view/candidato/index.tmpl',
      controller: 'CandidateController',
    }).
    when('/doar', {
      templateUrl: '/javascripts/app/view/candidato/doar.tmpl',
      controller: 'CandidateController',
    }).
    otherwise({
      redirectTo: '/',
    });
  }]);

  /**
   * Grafic interface and style interactions
   */
  $(document).ready(function(){
    $('body').on('click', 'input.opcao_doar_radio', function(e){
      e.preventDefault;
      if ($(this).hasClass('opcao_doar_diff')){
        $(this).closest('.valor-doa-container').find('.doar-number-diferente').attr('disabled', false);
      }else{
        $('.doar-number-diferente').attr('disabled', true);
      }
      $('.valor-doa-container').removeClass('doa-container-active');
      $(this).closest('.valor-doa-container').addClass('doa-container-active');
    });
    $('input.opcao_doar_radio:checked').trigger('click');
  });
}

/**
 * Candidate Controller
 */
app.votolegal.controller('CandidateController', ["$scope", "$http", "$sce", "serialize", "auth_service", "SweetAlert", "trouble", "postmon", function($scope, $http, $sce, serialize, auth_service, SweetAlert, trouble, postmon){
  // defaults
  $scope.candidate  = {};
  $scope.doar       = {};
  $scope.payment    = {};
  // getting candidate name from url
  $scope.name = (function get_subdomain(){
    var url = document.location.href;
    url = url.split(/\//)[2].split('.')[0];
    if(url !== 'localhost') return url;
  })();


  // methods
  $scope.make_percent = function(number, total){
    if(total === 0) return '0%';
    return ((number/total) * 100).toFixed(2) + '%'
  };

  //$scope.active_tab = function(href){
  //  var list = document.querySelectorAll('a[role=tab]').map(function(a){
  //    a.parentNode.classList.remove('active');
  //  });
  //};

  $scope.render_video = function(src){
    return '<iframe id="candidate_video" src="' + $sce.trustAsResourceUrl(src) + '" width="560" height="315" allowfullscreen></iframe>';
  };

  $scope._issues_priorities_decorator = function(separator){
    return $scope.candidate.candidate_issue_priorities
      .map(function(i){ return i.name })
      .join(separator || ', ')
  };

  $scope.candidate_by_name = function(name){
    $http({
      method: 'GET',
      url: '<%= config[:api_host]%>/candidate/'+ name,
    }).
    then(
      function(response){
        var res = response.data.candidate;
        $scope.candidate = res;

        (function(){
          var title = document.querySelector('title');
          if(title.innerText === 'VotoLegal - Candidato(a)') 
            title.innerText += (" " + $scope.candidate.popular_name);
        })();

        // header issues list
        $scope.candidate.issues_decorator = $scope._issues_priorities_decorator();

        // default total donated
        $scope.candidate.total_donated = $scope.candidate.total_donated || 0.0;
        $scope.candidate.raising_goal = parseFloat($scope.candidate.raising_goal) || 0.0;

        // video renderer
        (function(){
          var v = document.querySelector('#video-renderer');
          if(v) v.innerHTML = $scope.render_video(res.video_url);
        })();

        // load projects
        $scope.candidate.projects = [];
        $scope.candidate_projects(res);
      },
      function(response){
        trouble.shoot({
          route: document.location.href, error: JSON.stringify(response)
        });
        throw new Error('Model is invalid or cannot be found!');
      }
    );
    return false;
  };

  /* fetch zip_code info */
  $scope.address_by_zipcode = function(event){
    var zipcode = $scope.doar.address_zipcode;

    if(zipcode.length == 9){
      postmon(zipcode).then(
        // success callback
        function(response) {
          var res = response.data, $f = $scope.doar;
          $f.address_city   = res.cidade;
          $f.address_state  = res.estado_info.nome;
          
          // load district
          var district = document.querySelector('form[name=doarForm] *[name=address_district]');
          if(res.bairro) { $f.address_district = res.bairro; district.disabled = true }
          else {  $f.address_district = ""; district.disabled = false }

          // load street
          var street = document.querySelector('form[name=doarForm] *[name=address_street]');
          if(res.logradouro) { $f.address_street = res.logradouro; street.disabled = true }
          else { $f.address_street = ""; street.disabled = false }
        },
        // error callback
        function(response){
          swal({ title: "Problemas ao carregar os dados do CEP!", text: "Ocorreu um erro ao tentar carregar os dados de sua localidade. Verifique o CEP e tente novamente." });
          ['address_state', 'address_city', 'address_district', 'address_street'].map(function(i){ 
            try{ 
              $scope.candidate[i] = "";
              document.querySelector('form[name=doarForm] *[name='+i+']').disabled = true;
            } catch(e) {};
          });
          throw new Error("ERROR_GET_ZIPCODE");
        }
      );
    }

    return false;
  };


  /* fetch candidate projects */
  $scope.candidate_projects = function(candidate){
    $http({
      method: 'GET',
      url: '<%= config[:api_host]%>/candidate/'+ candidate.id +'/projects',
    }).
    then(
      function(response){
        var res = response.data.projects;
        
        (function(){
          var total = 0; res.map(function(p){ total += p.votes });
          res = res.map(function(i){ i.total = total; return i });
        })();

        $scope.candidate.projects = res;
      },
      function(response){
        trouble.shoot({
          route: document.location.href, error: JSON.stringify(response)
        });
        throw new Error('Project list is invalid or cannot be found!');
      }
    );
    return false;
  };


  /* setting donation amount */
  $scope.doar_continue = function(amount){
    if(!amount || amount < 10.00){
      SweetAlert.swal('Preencha um valor superior a 10,00 reais.');
      return false;
    }

    document.getElementById('amount-review').classList.remove('hide');
    var list = document.querySelectorAll('.valor-doa-container');
    for(var i in list) {
      if(list[i] && list[i].classList) list[i].classList.add('hide');
    }
    document.getElementById('doar-form').classList.remove('hide');

    // update amount value
    $scope.doar.amount = parseFloat(amount);

    // TODO uncomment this
    $scope.get_session();
  };


  /* doar edit method*/
  $scope.doar_edit = function(amount){
    document.getElementById('amount-review').classList.add('hide');
    var list = document.querySelectorAll('.valor-doa-container');
    for(var i in list) {
      if(list[i] && list[i].classList) list[i].classList.remove('hide');
    }
    document.getElementById('doar-form').classList.add('hide');
  };


  /* getting session */
  $scope.get_session = function(){
    var id = $scope.candidate.id || 0;
    $http({
      url: '<%= config[:api_host] %>/candidate/'+id+'/donate/session'
    }).
    then(function(response){
      $scope.payment.session = response.data.id;
      console.log('SESSION: '+ response.data.id);
      PagSeguroDirectPayment.setSessionId(response.data.id);
    }, function(response){
      trouble.shoot({
        route: '/cadastro/boleto', error: JSON.stringify(response)
      });
      throw new Error("ERROR_GET_SESSION");
    });
    return false
  };

  $scope.send_donation = function(){
    // sender
    var teste = PagSeguroDirectPayment.getSenderHash();

    /*
    // payment methods
    PagSeguroDirectPayment.getPaymentMethods({
      amount: parseFloat($scope.doar.amount),
      success: function(response){
        console.log(response);
      },
      error: function(response){
        SweetAlert.swal('Erro', 'Não foi possível obter os métodos de pagamento!');
        trouble.shoot({
          route: document.location.href, error: JSON.stringify(response);
        })
        throw new Error('PAGSEGURO_GET_PAYMENTMETHODS');
      },
      complete: function(response){ }
    });

    // card token
    PagSeguroDirectPayment.createCardToken({
      cardNumber: ''
      brand: '',
      cvv: '',
      expirationMonth: '',
      expirationYear: '',
      success: function(response){
      },
      error: function(response){
      },
      complete: function(response){
      }
      });
    */
  };

  $scope.donation_params = function(){
    return Params
      .required($scope.doar)
      .permit('')
  };

  $scope.candidate_by_name($scope.name);
}]);
