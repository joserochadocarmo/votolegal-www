if(document.location.href.indexOf('/candidato') >= 0){
  app.votolegal.config(['$routeProvider', function($routeProvider) {
    $routeProvider.
    when('/', {
      templateUrl: '/javascripts/app/view/candidato/index.tmpl',
      controller: 'CandidateController',
    }).
    when('/doar', {
      templateUrl: '/javascripts/app/view/candidato/doar.tmpl',
      controller: 'CandidateController',
    }).
    otherwise({
      redirectTo: '/',
    });
  }]);

  /**
   * Grafic interface and style interactions
   */
  $(document).ready(function(){
    $('body').on('click', 'input.opcao_doar_radio', function(e){
      e.preventDefault;
      $('.valor-doa-container').removeClass('doa-container-active');
      $(this).closest('.valor-doa-container').addClass('doa-container-active');
    });
    $('input.opcao_doar_radio:checked').trigger('click');
  });
}

/**
 * Candidate Controller
 */
app.votolegal.controller('CandidateController', ["$scope", "$http", "$sce", "serialize", "auth_service", function($scope, $http, $sce, serialize, auth_service){
  // defaults
  $scope.candidate  = {};
  $scope.doar       = {};
  $scope.payment    = {};
  // getting candidate name from url
  $scope.name = (function get_subdomain(){
    var url = document.location.href;
    url = url.split(/\//)[2].split('.')[0];
    if(url !== 'localhost') return url;
  })();


  // methods
  $scope.make_percent = function(number, total){
    if(total === 0) return '0%';
    return ((number/total) * 100).toFixed(2) + '%'
  };

  //$scope.active_tab = function(href){
  //  var list = document.querySelectorAll('a[role=tab]').map(function(a){
  //    a.parentNode.classList.remove('active');
  //  });
  //};

  $scope.render_video = function(src){
    return '<iframe id="candidate_video" src="' + $sce.trustAsResourceUrl(src) + '" width="560" height="315" allowfullscreen></iframe>';
  };

  $scope._issues_priorities_decorator = function(separator){
    return $scope.candidate.candidate_issue_priorities
      .map(function(i){ return i.name })
      .join(separator || ', ')
  };

  $scope.candidate_by_name = function(name){
    $http({
      method: 'GET',
      url: '<%= config[:api_host]%>/candidate/'+ name,
    }).
    then(
      function(response){
        var res = response.data.candidate;
        $scope.candidate = res;

        (function(){
          var title = document.querySelector('title');
          if(title.innerText === 'VotoLegal - Candidato(a)') 
            title.innerText += (" " + $scope.candidate.popular_name);
        })();

        // header issues list
        $scope.candidate.issues_decorator = $scope._issues_priorities_decorator();

        // default total donated
        $scope.candidate.total_donated = $scope.candidate.total_donated || 0.0;
        $scope.candidate.raising_goal = parseFloat($scope.candidate.raising_goal) || 0.0;

        // video renderer
        (function(){
          var v = document.querySelector('#video-renderer');
          if(v) v.innerHTML = $scope.render_video(res.video_url);
        })();

        // load projects
        $scope.candidate.projects = [];
        $scope.candidate_projects(res);
      },
      function(response){
        trouble({
          route: document.location.href, error: JSON.stringify(response)
        });
        throw new Error('Model is invalid or cannot be found!');
      }
    );
    return false;
  };

  $scope.candidate_projects = function(candidate){
    $http({
      method: 'GET',
      url: '<%= config[:api_host]%>/candidate/'+ candidate.id +'/projects',
    }).
    then(
      function(response){
        var res = response.data.projects;
        
        (function(){
          var total = 0; res.map(function(p){ total += p.votes });
          res = res.map(function(i){ i.total = total; return i });
        })();

        $scope.candidate.projects = res;
      },
      function(response){
        trouble({
          route: document.location.href, error: JSON.stringify(response)
        });
        throw new Error('Project list is invalid or cannot be found!');
      }
    );
    return false;
  };

  /* doação */
  $scope.doar_continue = function(amount){
    document.getElementById('amount-review').classList.remove('hide');
    var list = document.querySelectorAll('.valor-doa-container');
    for(var i in list) {
      if(list[i] && list[i].classList) list[i].classList.add('hide');
    }
    document.getElementById('doar-form').classList.remove('hide');
    $scope.get_session();
  };
  $scope.doar_edit = function(amount){
    document.getElementById('amount-review').classList.add('hide');
    var list = document.querySelectorAll('.valor-doa-container');
    for(var i in list) {
      if(list[i] && list[i].classList) list[i].classList.remove('hide');
    }
    document.getElementById('doar-form').classList.add('hide');
  };
  // session
  $scope.get_session = function(){
    var id = $scope.candidate.id || 0;
    $http({
      url: '<%= config[:api_host] %>/candidate/'+id+'/donate/session'
    }).
    then(function(response){
      console.log(response);
    }, function(response){
      console.log(response);
    });
    return false;
  };

  $scope.candidate_by_name($scope.name);
}]);
