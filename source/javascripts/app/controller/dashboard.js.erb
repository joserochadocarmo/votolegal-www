/**
 * Dashboard Controller
 */
app.votolegal.controller('DashboardController', ["$scope", "$http", "auth_service", "serialize", function($scope, $http, auth_service, serialize){
  // defaults
  $scope.list = [];


  // methods
  $scope.approval_list = function(){
    var user = auth_service.current_user();

    $http({
      method: 'GET', 
      url: '<%= config[:api_host] %>/admin/candidate/list?api_key=' + user.api_key, 
    })
    .then(
      function(response){
        var res = response.data;
        $scope.list = res;
        return false;
      },
      function(response){
        var data = response.data;

        // error: access denied
        if(data.error === "access denied") 
          document.location = auth_service.sign_page;

        return false;
      }
    );
  };


  $scope.allow = function(model){
    var user = auth_service.current_user();

    $http({
      method: 'PUT',
      url: '<%= config[:api_host] %>/admin/candidate/'+ model.id +'/activate?api_key='+ user.api_key,
    }).
    then(
      // success callback
      function(response){
        swal('Pré-candidato aprovado com sucesso');
        $scope.approval_list();
        return false;
      },
      // error callback
      function(response){
        var res = response.data;
        // error messages
        var error_msg  = function(token){
          var msg_list = {
            "access denied": "Acesso negado!",
          };
          return msg_list[token] || '';
        };

        // show message
        swal(error_msg(res.error));
        return false;
      }
    );
    return false;
  };

  $scope.deny = function(model){
    var user = auth_service.current_user();

    $http({
      method: 'PUT',
      url: '<%= config[:api_host] %>/admin/candidate/'+ model.id +'/deactivate?api_key='+ user.api_key,
    }).
    then(
      // success callback
      function(response){
        swal('Pré-candidato rejeitado com sucesso');
        $scope.approval_list();
        return false;
      },
      // error callback
      function(response){
        var res = response.data;
        // error messages
        var error_msg  = function(token){
          var msg_list = {
            "access denied": "Acesso negado!",
          };
          return msg_list[token] || '';
        };

        // show message
        swal(error_msg(res.error));
        return false;
      }
    );
    return false;
  };

  // load parties from api
  $scope.approval_list();

  // validate user
  auth_service.validate_user();
}]);
