/**
 * Candidate Controller
 */


app.votolegal.controller('PreviewController', ["$scope", "$rootScope", "$http", "$sce", "serialize", "auth_service", "edit_cadidate", "SweetAlert", "trouble", "postmon", function ($scope, $rootScope, $http, $sce, serialize, auth_service, edit_cadidate, SweetAlert, trouble, postmon){
  var load   = document.querySelector('#loading');

  // defaults
$scope.candidate  = {};


$scope.iframeStatus = {}

var locationHost = window.location.host;



  /**
   * getting data
   */
  $scope.get_candidate = function(){
    var params = {};

    var user = auth_service.current_user();
    params['api_key'] = user.api_key;

    $http.get(BASE_API_JS+'/candidate/' + user.id +'?api_key=' + user.api_key)
    .then(
      function(response){
		$scope.candidate = response.data.candidate;


        (function(){
          var boleto = document.querySelector('#show-boleto');
          if(boleto && $scope.candidate.status === 'activated') boleto.classList.remove('hide');
        })();

        $scope.candidate.profile_url = function(){
          return $sce.trustAsResourceUrl("//" + locationHost + "/candidato?id=" + $scope.candidate.username);
		};

      },
      function(response){ throw new Error('ERROR_GET_CANDIDATE') }
    );
    return false;
  };

  //Verify preview status, theme aand publish


	$scope.choiceTheme = function () {
		var previewWindow = document.getElementById('preview');


		previewWindow.contentWindow.postMessage($scope.iframeStatus, window.location.href);

	}

  $scope.editConfigSite = function(valid, formData){
	var previewWindow = document.getElementById('preview');

	if ( previewWindow != null ) {
		console.log ('pain of salvation');
		previewWindow.contentWindow.postMessage({active:true, classTheme:'azul'}, window.location.href);
	}

	  var user = auth_service.current_user();

	  console.log(formData.themeActive, 'teste')

    edit_cadidate.edit($scope.themeActive, user)
    .success(function (res) {
      console.log(res, 'res')
    }).error(function (er) {
      console.log(er)
	})
}

  /**
   * initializations
   */
  auth_service.validate_user({role: 'user'});
  $scope.get_candidate();
}]);
