if(document.location.href.indexOf('/cadastro-completo') >= 0){
  app.votolegal.config(['$routeProvider', function($routeProvider) {
    $routeProvider.
    when('/dados-pessoais', {
      templateUrl: '/javascripts/app/view/cadastro/dados-pessoais.tmpl',
      controller: 'CadastroController'
    }).
    when('/dados-campanha', {
      templateUrl: '/javascripts/app/view/cadastro/dados-campanha.tmpl',
      controller: 'CadastroController'
    }).
    when('/projetos', {
      templateUrl: '/javascripts/app/view/cadastro/projetos.tmpl',
      controller: 'CadastroController'
    }).
    otherwise({
      redirectTo: '/dados-pessoais'
    });
  }]);
}

/**
 * Cadastro controller
 * Register a new candidate
 */ 
app.votolegal.controller('CadastroController', ['$scope', '$http', '$location', 'auth_service', 'serialize', function($scope, $http, $location, auth_service, serialize){
  $scope.issues     = {};
  $scope.candidate  = {};
  $scope.projects   = [1, 2, 3, 4].map(function(){ return {title: '', description: ''}; });

  $scope.tabname    = 'pessoal';
  $scope.submit_disabled = false;
  $scope.progress   = { percent: 0 };
  $scope.issue_list = []; 


  // getting form params
  $scope.candidate_params = function(){
    return $scope.candidate;
  };
  // getting form params
  $scope.issues_params = function(){
    return $scope.candidate;
  };
  // getting form params
  $scope.projects_params = function(){
    var list = [];
    var project_list = document.querySelectorAll('.project-item');
    for(var i=0; i < project_list.length; i++) {
      var n = project_list[i];
      var id      = n.getAttribute("data-id").replace('item-', ''),
          title   = n.querySelector('input[name=project_title]').value,
          content = n.querySelector('textarea[name=project_content]').value;

      list.push({id, title, content});
    }
    return list;
  };

  // update candidate
  $scope.update_projects = function(isValid){
    var params       = {},
        project_list = $scope.projects_params();

    // errors
    $scope.error_list = [];

    // getting current user candidate
    var user = auth_service.current_user();
    params['api_key'] = user.api_key;

    for(var i in params){
      console.log(i);
    }
  };

  // 
  $scope.create_issue = function(isValid){
    var issue = $scope.issue_name; 
    var modal = $('#new-issue-priority').modal('hide');

    if(issue){
      var list = $scope.issue_list.filter(function(i){
        if(i.selected) return true;
      });

      if(list.length >= 4) {
        swal('Selecione apena 4 assuntos');
      }
      else {
        // TODO: Ajax to save issur
        $scope.issue_list.push({selected: true, id: 11, name: issue});
      }
    }

    $scope.issue_name = '';
    return false;
  };


  // update candidate
  $scope.update = function(isValid){
    var params = $scope.candidate_params();
    $scope.error_list = [];

    // getting current user candidate
    var user = auth_service.current_user();
    params['api_key'] = user.api_key;

    $scope.submit_disabled = true;
    $http.put('<%= config[:api_host] %>/candidate/' + user.id, serialize.from_object(params), {
      //headers: { 'Content-Type': false },
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      }
      //transformRequest: function (data) {
      //  var fd = new FormData();

      //  for (var p in data)
      //    fd.append(p, data[p]);

      //  // TODO: add image upload

      //  return fd;
      //}
      //headers: {'Content-Type': undefined},
      //data: serialize.from_object(params)
      //headers: {'Content-Type': 'enctype="multipart/form-data'}
      //headers: {'Content-Type': 'multipart/form-data'}
      //transformRequest: angular.identity
    });
    //.then(
    //  // success callback
    //  function(response){
    //    if($scope.error_list.length == 0) document.location = '/cadastro-completo/success';
    //  },
    //  // error callback
    //  function(response){
    //    var res = response.data.form_error;

    //    console.log(response);

    //    var f = function(field){
    //      return document.querySelector('form[name=candidateForm] *[name='+field+']');
    //    };

    //    // setting error message
    //    for(var field in res){
    //      var name = f(field).attributes['placeholder'].value;
    //      $scope.error_list.push(name + error_msg(res[field]));
    //    }

    //    // enable submit
    //    $scope.submit_disabled = false;

    //    // throw an exception
    //    throw new Error("ERROR_PUT_CADIDATE");
    //  }
    //);
    return false;
  };

  $scope._get_candidate = function(){
    var params = $scope.candidate_params();

    var user = auth_service.current_user();
    params['api_key'] = user.api_key;

    $http.get('<%= config[:api_host] %>/candidate/' + user.id, serialize.from_object(params))
    .then(
      function(response){
        var res = response.data.candidate;
        $scope.candidate = res;
      },
      function(response){
        console.log(response);
      }
    );
    return false;
  };

  $scope.count_checked = function(el){
    var list = $scope.issue_list.filter(function(i){
      if(i.selected) return true;
    });

    if(list.length > 4){
      if(el) el.i.selected = false;
      swal('Selecione apena 4 assuntos');
    }
    return false;
  };

  $scope.add_project = function(){
    $scope.projects.push({title: '', description: ''});
    return false;
  };

  // getting issue priority
  $scope.get_issues_priority = function(){
    $http.get('<%= config[:api_host] %>/issue_priority').
    then(
      function(response){
        var list = response.data.issue_priority;
        $scope.issue_list = list;
      },
      function(response){
        throw new Error('ERROR_GET_ISSUE_PRIORITY');
      }
    );
  };

  // getting route
  $scope._get_tabname = function(){
    var route = $location.path();
    if(route == '/dados-pessoais') return 'pessoal';
    if(route == '/dados-campanha') return 'campanha';
    if(route == '/projetos') return 'projetos';
  };
  
  // validate user
  auth_service.validate_user({role: 'user'});
  $scope.tabname = $scope._get_tabname();
  $scope._get_candidate();
  $scope.get_issues_priority();
}]);
